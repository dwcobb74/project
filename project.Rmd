---
title: "Final Project"
author: "David Cobb"
date: "March 23, 2019"
output: flexdashboard::flex_dashboard
vertical_layout: fill
runtime: shiny
---

```{r setup, include=FALSE}
library("flexdashboard")
library("MASS")
library("tidyverse")
library("broom")
library("glmnet")
library("caret")
library("ISLR")
library("janitor")
library("stringr")
library("randomForest")
library("nnet")
library("car")
library("GGally")
library("xtable")
library("rpart")
library("rpart.plot")
library("glmnet")
theme_set(theme_bw())
```


```{r data}
# Read Raw Data
fars <- read_csv("../project/car-safety-fars.csv")
fars_summary <- read_csv("../project/car-safety-fars-cleaned-data.csv")
```

```{r}
# Add MAKE_MODEL column to the raw data
fars = mutate(fars,
   MAKE_MODEL = paste(VINMAKE_T, VINMODEL_T, sep = '_'))
```

```{r}
# Create Training and Testing Data
set.seed(1)
df_fars <- tbl_df(fars)
inTraining <- createDataPartition(df_fars$Fatal_Injury, p = .50, list = F)
                                  training <- df_fars[inTraining,]
                                  testing <- df_fars[-inTraining,]
```

Page 1 - Summary Table
=====================================  

```{r}
fars_filter <- filter(fars_summary, MAKE_MODEL != "_")
by_make_model <- group_by(fars_filter, MAKE_MODEL,DRIVETYP, DISPCLMT, TURBO_T, SUPCHRGR_T)
new <- summarize(by_make_model, 
                 fatals = sum(Fatal_Injury),
                 injuries = sum(Suspected_Minor_Injury + Suspected_Serious_Injury),
                 no_injury = sum(No_Apparent_Injury))
renderDataTable(new)
```

Page 2 - Summary Charts {data-orientation=rows}
=====================================     

### Chart 1 
```{r}
chart1 <- ggplot(data = new) +
  #geom_point(mapping = aes(x = DRIVETYP, y = fatals)) +
  geom_col(mapping = aes(x = DRIVETYP, y = fatals)) +
  theme_light()
chart1
```

### Chart 2

```{r}
chart2 <- ggplot(data = fars, 
            aes(x = Fatal_Injury, y = DISPCLMT))
chart2 + geom_violin(alpha = .15) +
  scale_color_brewer(palette = "Dark2") +
  guides(col = F)
```
   
Page 3 - Summary Charts 2  {data-orientation=rows}
=====================================  

### Chart 4 - Fatal Injuries Compared to Drive Type and Displacement
```{r}
fars_displacement <- filter(fars, DISPCLMT != "NA")
chart4 <- ggplot(data = fars_displacement,
            aes(x = Fatal_Injury, y = DISPCLMT, fill = DRIVETYP)) +
theme(legend.position="bottom")
chart4 + geom_violin() 
```   
    
### Chart 5 - Scatter Chart of Fatal Injuries compared to Engine Size
```{r}
chart5 <- ggplot(new, aes(x = DISPCLMT, y = fatals)) +
  geom_point() +
  scale_x_discrete(labels = abbreviate) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
chart5
```

Page 4 - Logistic Regression
=====================================  
### Logistic Regression Using 4 Variables
```{r}
lrm <- tidy(glm(Fatal_Injury ~ DRIVETYP + TURBO_T + SUPCHRGR_T + MAKE_MODEL, data = fars))
renderDataTable(lrm)
```

Page 5 - Tree Attempt
=====================================  
### Logistic Regression Using 4 Variables
```{r}
first_tree <- tree::tree(Fatal_Injury ~ VEHTYPE_T + DRIVETYP + DISPCLMT + TURBO_T, 
                         data = fars,
                         minsize = 100)
plot(first_tree)
text(first_tree, cex=.75)
```

Page 6 - Another Chart
=====================================  
### Fatals by Drive Type and Turbo Charged
```{r}
chart3 <- ggplot(data = fars_filter) +
  geom_point(aes(x = DRIVETYP,  y = TURBO_T,  size = Fatal_Injury)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
chart3
```